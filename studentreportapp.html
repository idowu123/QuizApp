<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Report App</title>
<link rel="manifest" href="/manifest.json">
<style>
body{font-family:sans-serif; padding:20px; background:#f7f5f5;}
h2{color:#0b63d6;}
.section{display:none; margin-bottom:20px; padding:16px; border-radius:8px; box-shadow:0 20px 50px rgba(0,0,0,0.1);}
.active{display:block;}
input{width:100%; max-width:220px; padding:6px; margin-bottom:6px; box-sizing:border-box;}
button{padding:6px 12px; margin:4px 2px; cursor:pointer; border:none; border-radius:4px; color:#fff; background:#0b63d6;}
button:hover{opacity:0.9;}
table{border-collapse:collapse; width:100%; margin-top:10px; text-align:center;}
th, td{border:1px solid #ccc; padding:6px;}
.totalCell{background:#ffeeba;}
.steps button{margin:4px; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;}
.currentStep{background:red; color:#fff;}
.completedStep{background:#0b63d6; color:#fff;}
#reportPreview{overflow-x:auto;}
@media (max-width:600px){
  input{max-width:100%;}
  button{width:100%;}
}

a{
color:white;
text-decoration: none;
  }
.studentName{
  background-color: rgb(1, 1, 51);
  color:white;
}
.livechat{
  color:hsla(277, 87%, 3%, 0.164);
  font-style: italic;
  font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
  animation:blink 2s infinite;
}
.livechat:hover{
  color:rgb(255, 115, 0);  
}
@keyframes blink{
  0%{
    opacity:1;
  }
  50%{
    opacity:0;
  }
  100%{
    opacity:1;
  }
}
.red-card{
height: 20px;
width:40px;
background-color:#f8d7da ;
display: block;
}

.green-card{
height: 20px;
width:40px;
background-color:#d4edda ;
display: block;
}
</style>
</head>
<body>
<h2>Student Report App</h2>

<div class="steps">
  <button id="btnStep1" onclick="showStep(1)">Step 1</button>
  <button id="btnStep2" onclick="showStep(2)">Step 2</button>
  <button id="btnStep3" onclick="showStep(3)">Step 3</button>
  <button id="btnStep4" onclick="showStep(4)">Step 4</button>
</div>

<!-- Step 1 -->
<div id="step1" class="section active">
  <h3>Step 1: School Info</h3>
  <input id="schoolName" placeholder="School Name"><br>
  <input id="className" placeholder="Class Name"><br>
  <input id="teacherName" placeholder="Teacher Name"><br>
  <label>School Logo:</label>
  <input type="file" id="schoolLogo" accept="image/*"><br>
  <img id="logoPreview" src="" alt="" style="max-width:150px; margin-bottom:10px; display:none;"><br>
  <button onclick="saveStep1()">Save & Next</button>
</div>

<!-- Step 2 -->
<div id="step2" class="section">
  <h3>Step 2: Subjects</h3>
   <p>Input Numbers of subjects and Generate Subjects </p>
  <input id="subjectCount" type="number" value="3" min="1">
  <button onclick="generateSubjects()">Generate Subjects</button>
  <div id="subjectsContainer"></div>
  <button onclick="showStep(1)">Back</button>
  <button onclick="saveStep2()">Save & Next</button>
<p>Create Subject with acronym to make student report look responsive on mobile phone
    e.g <ul>
      <li><acronym title="Physics">phy</acronym></li>
      <li><acronym title="Biology">Bio</acronym></li>
      <li><acronym title="Physical Health Education">PHE</acronym></li>
      <li><acronym title="English">Eng</acronym></li>
      <li><acronym title="Basic Science">BS</acronym></li>
      <li><acronym title="Christian Religious Studies">CRK</acronym></li>
    </ul>
  </p>

</div>

<!-- Step 3 -->
<div id="step3" class="section">
  <h3>Step 3: Students</h3>
   <p>Input Numbers of students and Generate Students</p>
  <input id="studentCount" type="number" value="3" min="1">
  <button onclick="generateStudents()">Generate Students</button>
  <div id="studentsContainer"></div>
  <button onclick="showStep(2)">Back</button>
  <button onclick="saveStep3()">Save & Next</button>
</div>

<!-- Step 4 -->
<div id="step4" class="section">
  <h3>Step 4: Generate Report</h3>
  <button id="generate_report"  onclick="generateReport()">Generate Report</button>
  <button onclick="downloadPDF()">Download PDF</button>
  <button onclick="downloadWord()">Download Word</button>
  <p>Ensure You  Download as PDF OR Word Document before you close this page!</p>
  <div id="reportPreview"></div>
  <p id="report_status"></p>
   <P  id = 'show_report' style="font-size:12px"></P><br>
   <p><a class="livechat" href="https://wa.me/7010067689">Live Chat <img src="livechat.png"  width="50px"></a></p>
  <p style="font-size:12px">All Right Reserved <br>
    Noble Studio Lagos, Copyright © 2025</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>

const button = document.getElementById('generate_report');
button.addEventListener('click', function(){
  document.getElementById('show_report').innerHTML =`Fail:❌<div class="red-card"></div> <br>  Pass:✅ <div class="green-card"></div> <br> Would you like to generate result for a single student, input comment, position(Rank from  the above combine Report) and this will serve as individual Report Sheet For the term:<br> <button><a href="generatesingle.html">Generate Report For Single Student</button> `
});

let subjects=[], students=[], schoolLogoData='';

// Step navigation
function updateStepButtons(current){
  for(let i=1;i<=4;i++){
    const btn=document.getElementById('btnStep'+i);
    btn.classList.remove('currentStep','completedStep');
    if(i===current) btn.classList.add('currentStep');
    else btn.classList.add('completedStep');
  }
}
function showStep(n){
  updateStepButtons(n);
  for(let i=1;i<=4;i++) document.getElementById('step'+i).classList.remove('active');
  document.getElementById('step'+n).classList.add('active');
}

// Step 1
document.getElementById('schoolLogo').addEventListener('change', e=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=function(evt){
      schoolLogoData=evt.target.result;
      const img=document.getElementById('logoPreview');
      img.src=schoolLogoData; img.style.display='block';
    };
    reader.readAsDataURL(file);
  }
});
function saveStep1(){ showStep(2); }

// Step 2
function generateSubjects(){
  const count=Number(document.getElementById('subjectCount').value);
  const container=document.getElementById('subjectsContainer');
  container.innerHTML='';
  for(let i=0;i<count;i++){
    const input=document.createElement('input');
    input.placeholder=`Subject ${i+1}`;
    input.className='subject';
    container.appendChild(input);
    container.appendChild(document.createElement('br'));
  }
}
function saveStep2(){
  subjects=Array.from(document.getElementsByClassName('subject')).map(i=>i.value||'Unnamed');
  if(subjects.length===0){alert('Add at least 1 subject');return;}
  showStep(3);
}

// Step 3
function generateStudents(){
  const count=Number(document.getElementById('studentCount').value);
  const container=document.getElementById('studentsContainer');
  container.innerHTML='';
  for(let i=0;i<count;i++){
    const nameInput=document.createElement('input');
    nameInput.placeholder=`Student ${i+1} Name`;
    nameInput.className='studentName';
    container.appendChild(nameInput);
    container.appendChild(document.createElement('br'));
    subjects.forEach((sub,j)=>{
      const test=document.createElement('input');
      test.type='number'; test.placeholder=`${sub} Test`;
      test.className=`student${i}_test${j}`;
      const exam=document.createElement('input');
      exam.type='number'; exam.placeholder=`${sub} Exam`;
      exam.className=`student${i}_exam${j}`;
      container.appendChild(test);
      container.appendChild(exam);
      container.appendChild(document.createElement('br'));
    });
  }
}
function saveStep3(){
  const studentNames=document.getElementsByClassName('studentName');
  if(studentNames.length===0){alert('Please generate student data first');return;}
  const filled=Array.from(studentNames).some(i=>i.value.trim()!=='');
  if(!filled){alert('Enter at least one student name');return;}
  showStep(4);
}

// Step 4 - generate report
function generateReport(){
  students = [];
  const count = Number(document.getElementById('studentCount').value);
  for (let i = 0; i < count; i++) {
    const name = document.getElementsByClassName('studentName')[i].value || `Student ${i + 1}`;
    const scores = {};
    subjects.forEach((sub, j) => {
      const t = Number(document.getElementsByClassName(`student${i}_test${j}`)[0]?.value) || 0;
      const e = Number(document.getElementsByClassName(`student${i}_exam${j}`)[0]?.value) || 0;
      scores[sub] = { test: t, exam: e, total: t + e };
    });
    const total = Object.values(scores).reduce((a, b) => a + b.total, 0);
    const maxTotal = subjects.length * 100;
    const percentage = (total / maxTotal) * 100;
    students.push({name, scores, total, percentage: percentage.toFixed(0)});
  }

  students.sort((a, b) => b.total - a.total);
  students.forEach((s, i) => s.rank = i + 1);

  let html = '';
  if (schoolLogoData) html += `<img src="${schoolLogoData}" style="max-width:100px;"><br>`;
  html += `<strong>School:</strong> ${document.getElementById('schoolName').value}<br>`;
  html += `<strong>Class:</strong> ${document.getElementById('className').value}<br>`;
  html += `<strong>Teacher:</strong> ${document.getElementById('teacherName').value}<br><br>`;
  const now = new Date();
  html += `<strong>Generated on :</strong> ${now.toLocaleString()}<br><br>`;

  html += `<table><thead><tr><th>Name</th>`;
  subjects.slice(0, 8).forEach(s => html += `<th></th>`);
  html += `<th>Grand Total</th><th>Percentage</th><th>Rank</th></tr></thead><tbody>`;

  students.forEach(s => {
    const chunkSize = 8;
    const subjectChunks = [];
    for (let i = 0; i < subjects.length; i += chunkSize) subjectChunks.push(subjects.slice(i, i + chunkSize));
    html += `<tr><td rowspan="${subjectChunks.length * 3}">${s.name}</td>`;
    subjectChunks.forEach((chunk, idx) => {
      if (idx > 0) html += `<tr>`;
      chunk.forEach(sub => { html += `<td><strong>${sub}</strong><br>Test: ${s.scores[sub].test}</td>`; });
      if (idx === 0) {
        const grandColor = s.total / (subjects.length*100) >= 0.5 ? '#d4edda' : '#f8d7da';
        html += `<td rowspan="${subjectChunks.length * 3}" style="background:${grandColor}; font-weight:600">${s.total}</td>`;
        html += `<td rowspan="${subjectChunks.length * 3}">${s.percentage}%</td>`;
        html += `<td rowspan="${subjectChunks.length * 3}">${s.rank}</td>`;
      }
      html += `</tr><tr>`;
      chunk.forEach(sub => { html += `<td>Exam: ${s.scores[sub].exam}</td>`; });
      html += `</tr><tr>`;
      chunk.forEach(sub => { html += `<td>Total: ${s.scores[sub].total}</td>`; });
      html += `</tr>`;
    });
    html += `<tr><td colspan="${Math.min(8, subjects.length)+2}" style="height:10px;background:#f5f5f5;"></td></tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById('reportPreview').innerHTML = html;
}

// Cordova-ready PDF download
function downloadPDF() {
    const element = document.getElementById('reportPreview');
    html2pdf().from(element).set({ margin:10, jsPDF:{orientation:'landscape', unit:'mm', format:'a4'} })
    .output('blob').then(function(pdfBlob){
        const fileName = "Report.pdf";
        window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory + "Download/", function(dirEntry){
            dirEntry.getFile(fileName, { create: true }, function(fileEntry){
                fileEntry.createWriter(function(fileWriter){
                    fileWriter.write(pdfBlob);
                    alert("PDF saved to Downloads: " + fileName);
                });
            });
        });
    });
}

// Cordova-ready Word download
function downloadWord() {
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                 "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                 "xmlns='http://www.w3.org/TR/REC-html40'>;"+
                 "<head><meta charset='utf-8'><title>Document</title></head><body>";
    const footer = "</body></html>";
    const content = document.getElementById('reportPreview').innerHTML;
    const blob = new Blob([header+content+footer], {type:'application/msword'});
    const fileName = "Report.doc";
    window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory + "Download/", function(dirEntry){
        dirEntry.getFile(fileName, { create: true }, function(fileEntry){
            fileEntry.createWriter(function(fileWriter){
                fileWriter.write(blob);
                alert("Word saved to Downloads: " + fileName);
            });
        });
    });
}

// Init
updateStepButtons(1);
</script>
</body>
</html>